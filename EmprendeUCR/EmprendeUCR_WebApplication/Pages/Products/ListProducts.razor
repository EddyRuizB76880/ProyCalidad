@page "/ListProducts"
@using EmprendeUCR_WebApplication.Data.Services
@using EmprendeUCR_WebApplication.Data.Entities
@inject EntrepreneurService EntrepreneurService
@inject CategoryService CategoryService
@inject ProductService ProductService
@using Syncfusion.Blazor.TreeGrid;
@inject Product_ServiceService Product_ServiceService
@inject Product_PhotosService Product_PhotosService

@if (_isLoading)
{
    <p>Cargando...</p>
}
else
{

    <select @onchange="loadAllProducts" class="dropdown">
        <option value="" selected disabled>Emprendedor Logeado</option>
        @if (entrepreneurs?.Count > 0)
        {
            @foreach (var cnt in entrepreneurs)
            {
                <option value="@cnt.User_Email">@cnt.User_Email</option>
            }
        }
    </select>
    <head>

        <link rel="stylesheet" href="~/css/EmprendeUCR-template.css" />
    </head>

    <body>


        <header>
            <div class="icon-m display-2"> Mis Productos</div>
        </header>

        <section class="w-70  float_right ">

            <div class="layout wrap">
                @if (_products?.Count > 0)
                {
                    @foreach (var prod in _products)
                    {
                        var prodServ = _productsServices.First(p => p.Code_ID == prod.Code_ID);
                        var prodPhoto = photosDisplay.FirstOrDefault(p => p.Code_ID == prod.Code_ID);
                        <div class="item data border-1 border-blue content-center">
                            @if (prodPhoto != null)
                            {
                                <img src="@Product_PhotosService.convertImageDisplay(prodPhoto.Photos)" width="200" />
                            }
                            <div class="item ">
                                <div class="item_name">@prod.Product_Name</div>
                                <div class="item_description">@prod.Product_Description</div>
                                <div class="item_price">₡@prod.Price</div>
                            </div>
                        </div>
                    }
                }
            </div>
        </section>




        <aside class="w-25 float_left mb-0">
            <div class=" border-blue " @onchange="loadCategories">
                <h2 class="text-center fs-2  bg-blue">Categorias</h2>
                @if (_my_categories?.Count > 0)
                {   //jala la llave del papa no se trae los hijos
                    <SfTreeGrid ID="TreeGrid" @ref="TreeGrid" AllowSorting="true" AllowRowDragAndDrop="true" DataSource="@_my_categories" IdMapping="Id" ParentIdMapping="ParentId" AllowSelection="true" TreeColumnIndex="0">
                        <TreeGridEvents TValue="Category" RowDropped="Rowdrop" RowSelected="SelectionHandler"></TreeGridEvents>
                        <TreeGridSortSettings>
                            <TreeGridSortColumns>
                                <TreeGridSortColumn Field="Title" Direction="Syncfusion.Blazor.Grids.SortDirection.Ascending"></TreeGridSortColumn>
                            </TreeGridSortColumns>
                        </TreeGridSortSettings>
                        <TreeGridColumns>
                            <TreeGridColumn Field="Title" HeaderText="Nombre" Width="100"></TreeGridColumn>
                            <TreeGridColumn Field="Description" HeaderText="Descripción" Width="160"></TreeGridColumn>
                        </TreeGridColumns>
                    </SfTreeGrid>

                }
            </div>


            <NavLink class="nav-link" href="AddProduct">
                <button class="btn btn-primary" aria-hidden="true">Agregar nuevo Producto</button>
            </NavLink>

        </aside>
     

    </body>
}


@code {
    private bool _isLoading = true;
    private IList<EmprendeUCR_WebApplication.Data.Entities.Product> _products;
    private IList<EmprendeUCR_WebApplication.Data.Entities.Product_Service> _productsServices;
    private IList<EmprendeUCR_WebApplication.Data.Entities.Category> _categories;
    private IList<EmprendeUCR_WebApplication.Data.Entities.Category> _my_categories = new List<Category>();
    IList<Entrepreneur> entrepreneurs;
    IList<Product_Photos> photosDisplay;
    SfTreeGrid<Category> TreeGrid { get; set; }


    public async Task loadAllProducts(ChangeEventArgs email)
    {
        _my_categories.Clear();
        await loadProducts(email);
        await loadProductsServices(email);

        await loadCategories();
    }

    public async Task loadCategories()
    {
        _my_categories.Clear();
        foreach (var prod in _products)
        {
            Category cat = CategoryService.getCategory(prod.Category_ID);

            Category iterator = CategoryService.getCategory(prod.Category_ID);

            while (iterator.ParentId != null) {

                Category parentcat = CategoryService.getCategory((int)iterator.ParentId);

                if (!_my_categories.Contains(parentcat))
                {
                    _my_categories.Add(parentcat);
                }

                iterator = parentcat;
            }

            if (!_my_categories.Contains(cat))
            {
                _my_categories.Add(cat);
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        entrepreneurs = await EntrepreneurService.GetAsync();
        _categories = await CategoryService.GetAsync();
        photosDisplay = Product_PhotosService.loadAllPhotos();
        _isLoading = false;
    }
    bool hideError = true;
    public async Task loadProducts(ChangeEventArgs email)
    {
        _products = await ProductService.GetProductsEntrepreneurAsync(email.Value.ToString());
    }

    public async Task loadProductsServices(ChangeEventArgs email)
    {
        _productsServices = await Product_ServiceService.GetProductsServicesEntrepreneurAsync(email.Value.ToString());
    }




    // metodos para prueba de categories

    //RowDrop
    private void Rowdrop(Syncfusion.Blazor.Grids.RowDragEventArgs<Category> args)
    {
        CategoryService.Rowdrop(args, this.TreeGrid);
    }

    //SelectionHandler



    public async Task SelectionHandler(Syncfusion.Blazor.Grids.RowSelectEventArgs<Category> args)
    {
        var SelectedCategories = await this.TreeGrid.GetSelectedRecords();

    }



}



