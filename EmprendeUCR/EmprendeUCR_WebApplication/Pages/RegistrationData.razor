<!--Registration data page-->
@page "/registrationData"
@using EmprendeUCR_WebApplication.Data.Services
@using EmprendeUCR_WebApplication.Data.Entities
@using EmprendeUCR_WebApplication.Data.Services.Categories
@using Microsoft.AspNetCore.WebUtilities
@inject UserService UserService
@inject ClientService ClientService
@inject EntrepreneurService EntrepreneurService
@inject AdministratorService AdministratorService
@inject CredentialsService CredentialsService
@inject MembersService MembersService
@inject ProvinceService ProvinceService
@inject CantonService CantonService
@inject DistrictService DistrictService
@inject CategoryService CategoryService
@inject MembersService MembersService
@inject LikesService LikesService
@inject NavigationManager NavigationManager
@inject Email_ConfirmationService Email_ConfirmationService
@inject IJSRuntime JsRuntime
@inject PhonesService PhonesService
@inject Shopping_CartService Shopping_CartService
@using Syncfusion.Blazor.Inputs

<!--HTML-->
@if (typeOfUser == "Client")
{
    <h3>Registro cliente</h3>
}
else if (typeOfUser == "Entrepreneur")
{
    <h3>Registro Emprendedor</h3>
}
else // Administrator
{
    <h3>Registro Administrador</h3>
}
<p> Por favor complete los espacios en blanco para finalizar el registro.</p>
@if (_isLoading)
{
    <h3>Cargando...</h3>
}
else
{
    <EditForm Model="@newUser" OnValidSubmit="@insertUser">
        <div class="principal">

            <div class="principalObject">

                <div class="flexDivEnd">

                    <div class="objects">
                        <!--Email-->
                        <div class="marginElements">
                            <label for="staticEmail" class="form-label secondary_title">Correo electrónico:</label>
                            <InputText type="text" @bind-Value="@_email.Email" class="form-control inputsClass" id="staticEmail" placeholder="@_email.Email" readonly />
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label" style="font-size: 25px">Telefono</label>
                            <!-- <InputNumber placeholder="0000-0000" @bind-Value="number" />-->
                            @*<SfMaskedTextBox Mask="0000-0000" @bind-Value="newPhone.Phone_Number"></SfMaskedTextBox>*@
                            <InputText type="text" @bind-Value="@newPhone.Phone_Number" class="form-control inputsClass" id="staticEmail" placeholder="@newPhone.Phone_Number" required maxlength="8" />

                        </div>
                        <!--Name-->
                        <div class="marginElements">
                            <label for="inputName" class="form-label secondary_title">Nombre:</label>
                            <InputText type="text" @bind-Value="newUser.Name" class="form-control inputsClass" id="inputName" maxlength="15" required />
                        </div>

                        <!--First last name-->
                        <div class="marginElements">
                            <label for="inputFLastName" class="form-label secondary_title">Primer apellido</label>
                            <InputText type="text" @bind-Value="newUser.F_Last_Name" class="form-control inputsClass" id="inputFLastName" maxlength="15" required />
                        </div>

                        <!--Second last name-->
                        <div class="marginElements">
                            <label for="inputSLastName" class="form-label secondary_title">Segundo apellido</label>
                            <InputText type="text" @bind-Value="newUser.S_Last_Name" class="form-control inputsClass" id="inputSLastName" maxlength="15" required />
                        </div>

                        <!--Birth date-->
                        <div class="marginElements">
                            <label for="inputBDate" class="control-label secondary_title">Fecha de nacimiento:</label>
                            <InputDate type="date" @bind-Value="newUser.Birth_Date" class="form-control birthdate" id="inputBDate" />
                        </div>

                        <!--Image-->
                        <div class="marginElements">
                            <div class="flexElementsColumns">
                                <label for="imageUser" class="secondary_title">Foto de perfil:</label>
                                @if (imageUrl != "")
                                {
                                    <img src="@imageUrl" class="userImage" />
                                }
                                else
                                {
                                    <img src="/images/images.png" class="userImage" />
                                }
                                <InputFile OnChange="uploadImage" class="uploadPhoto form-control" accept="image/png, image/jpg, image/jpeg" id="imageUser" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="principalObject">
                <div class="flexDivStart">
                    <div class="objects">
                        <!--Address-->
                        <!--Province, Canton and District-->
                        <div class="marginElements">
                            <label class="control-label secondary_title">Dirección:</label>
                        </div>

                        <div class="marginElements flexElementsColumns">
                            <label for="Province" class="secondary_title control-label">Provincia:</label>
                            <select id="Province" class="form-control" @onchange="getCantons" required>
                                <option value="" selected hidden>Provincia</option>
                                @foreach (var province in _province)
                                {
                                    <option>@province.Name</option>
                                }
                            </select>
                        </div>

                        <div class="marginElements flexElementsColumns">

                            <label for="Canton" class="secondary_title control-label">Cantón:</label>
                            <select id="Canton" class="form-control" @onchange="getDistricts" disabled required>
                                <option value="" selected hidden>Cantón</option>
                                @foreach (var canton in _canton)
                                {
                                    <option>@canton.Name</option>
                                }
                            </select>
                        </div>

                        <div class="marginElements flexElementsColumns">

                            <label for="District" class="secondary_title control-label">Distrito:</label>
                            <select id="District" class="form-control" disabled required>
                                <option value="" selected hidden>Distrito</option>
                                @foreach (var district in _district)
                                {
                                    <option>@district.Name</option>
                                }
                            </select>
                        </div>

                        <!--Exact address-->
                        <div class="marginElements">
                            <label class="secondary_title">Dirección exacta: </label>
                            <InputTextArea class="form-control inputsClass" @bind-Value="newMembers.Direction" maxlength="200" rows="3" required></InputTextArea>
                        </div>

                        <!--Categories and Presentation-->
                        <div class="marginElements">
                            <!--Categories only for client users-->
                            @if (typeOfUser == "Client")
                            {
                                <!-- Button trigger modal -->
                                <div class="marginElements flexElementsColumns">
                                    <label class="secondary_title">Categorías preferidas: </label>
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                        Ver categorías
                                    </button>
                                </div>

                                <!-- Modal -->
                                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Seleccione las categorías de su preferencia</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="accordion" id="accordionCategories">

                                                    @{
                                                        IList<IList<Category>> _selectCategories = new List<IList<Category>>();
                                                        IList<Category> _parents = CategoryService.getParents();
                                                        IList<Category> _children;
                                                        IList<Category> _subCategory = new List<Category>();

                                                        foreach (var parents in _parents)
                                                        {
                                                            _subCategory.Clear();
                                                            _subCategory.Add(parents);
                                                            _children = CategoryService.getChildrenOf((int)parents.Id);
                                                            setNewCategory(_children);
                                                            _selectCategories.Add(new List<Category>(_subCategory));
                                                        }

                                                        void setNewCategory(IList<Category> parentCategory)
                                                        {
                                                            foreach (var newParent in parentCategory)
                                                            {
                                                                _subCategory.Add(newParent);
                                                                setNewCategory(CategoryService.getChildrenOf((int)newParent.Id));
                                                            }
                                                        }
                                                    }

                                                    <div class="accordion-item flexElementsColumns">
                                                        @foreach (var category in _selectCategories)
                                                        {
                                                            <label class="secondary_title" id="@category.First().Id">
                                                                <div class="form-check styleDropdown">
                                                                    <input type="checkbox" id="box_@category.First().Id" value="@category.First().Id" />
                                                                    <label class="marginDropdown" for="box_@category.First().Id">@category.First().Title</label>
                                                                    <button class="accordion-button collapsed acordionSize" type="button" data-bs-toggle="collapse" data-bs-target="#cat_@category.First().Id" aria-expanded="false" aria-controls="cat_@category.First().Id"></button>
                                                                </div>
                                                            </label>
                                                            <div id="cat_@category.First().Id" class="accordion-collapse collapse" aria-labelledby="@category.First().Id" data-bs-parent="#accordionCategories">
                                                                <div class="accordion-body">
                                                                    @foreach (var innerCategory in category)
                                                                    {
                                                                        if (innerCategory != category.First())
                                                                        {
                                                                            <div class="form-check">
                                                                                <input type="checkbox" id="box_@innerCategory.Id" value="@innerCategory.Id" />
                                                                                <label class="marginDropdown" for="box_@innerCategory.Id">@innerCategory.Title</label>
                                                                            </div>
                                                                        }
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer flex-center">
                                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!--Presentation Only for entrepreneur users-->
                            @if (typeOfUser == "Entrepreneur")
                            {
                                <label class="secondary_title">Presentación</label>
                                <InputTextArea class="form-control inputsClass" @bind-Value="newEntrepreneur.Presentation" maxlength="210" rows="3"></InputTextArea>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Submit button, execute de registrations button-->
        <center>
            <button type="submit" class="btn btn-primary marginButton">Registrarse</button>
        </center>
    </EditForm>
}

@code{
    /*Registration data Atributes*/
    //Global
    private bool _isLoading = true;
    //Entities
    private User newUser = new User();
    private Members newMembers = new Members();
    private Administrator newAdmin = new Administrator();
    private Entrepreneur newEntrepreneur = new Entrepreneur();
    //Password
    private string password;
    private string txtType = "password";
    private string text = "Mostrar";
    //Address
    private string province;
    private string canton;
    private string district;
    private IList<Province> _province;
    private IList<Canton> _canton;
    private IList<District> _district;
    //Image
    private string imageUrl = "";
    private byte[] buffer;
    //Categories
    private IList<Category> _categories;
    //Confirmarion email Atributes
    private bool _verificandoCorreo = true;
    private string hash_correo = "";
    private Email_Confirmation _email;
    private bool error = false;
    //Type of User
    private string typeOfUser;
    private Phones newPhone = new Phones();
    int number;
    /*
    Brief: Load provinces, cantons, districts and main categories.
    Parameters:
    Returns:
    */
    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        QueryHelpers.ParseQuery(uri.Query).TryGetValue("type", out var type);
        typeOfUser = type;
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("email", out var parameter))
        {
            hash_correo = parameter;
        }
        if (!string.IsNullOrEmpty(hash_correo))
        {
            _email = Email_ConfirmationService.getEmailConfirmation(hash_correo);
            if (_email == null)
            {
                NavigationManager.NavigateTo("/messagePage?type=3");
                error = true;
            }
            else
            {
                bool confirmado = UserService.getConfirmEmail(_email.Email);
                if (confirmado)
                {
                    NavigationManager.NavigateTo("/messagePage?type=3");
                    error = true;
                }
                bool expiration = Email_ConfirmationService.verifyExpirationDate(_email);
                if (expiration)
                {
                    NavigationManager.NavigateTo("/ExpirationError?email=" + _email.Hash_Code + "&type=" + 1);
                    error = true;
                }
            }
        }
        if (!error)
        {
            _province = await ProvinceService.GetAsync();
            _canton = await CantonService.GetAsync();
            _district = await DistrictService.GetAsync();
            _categories = await CategoryService.GetAsync();
            _isLoading = false;
        }
    }

    /*
    Brief: Shows the profile picture that the user uploaded.
    Parameters InputFileChangeEventArgs e:
    Returns:
    */
    private async Task uploadImage(InputFileChangeEventArgs e)
    {
        foreach (var imageFile in e.GetMultipleFiles(1))
        {
            var contentType = imageFile.ContentType;
            string fileType = contentType.ToString().Substring(0, 5);
            if (!fileType.Equals("image"))
            {
                await JsRuntime.InvokeVoidAsync("alerta", "Asegurese que el archivo es una imagen, y que esta se refleje en el recuadro");
                imageUrl = "/images/images.png";
                break;
            }
            var resizedFile = await imageFile.RequestImageFileAsync("image/png", 200, 200);
            buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream().ReadAsync(buffer);
            imageUrl = $"data:image/png;base64,{Convert.ToBase64String(buffer)}";
        }
    }

    /*
    Brief: Store the information of the new user in the database.
    Parameters:
    Returns:
    */
    private async void insertUser()
    {


        var ageInDays = DateTime.Now - newUser.Birth_Date;
        if (ageInDays.TotalDays >= 6570) //18 years in days
        {
            Phones p = new Phones
            {
                User_Email = _email.Email,
                Phone_Number = newPhone.Phone_Number,
            };


            PhonesService.addPhone(p);





            User u = new User
            {
                Email = _email.Email,
                Name = newUser.Name,
                F_Last_Name = newUser.F_Last_Name,
                S_Last_Name = newUser.S_Last_Name,
                Birth_Date = newUser.Birth_Date,
                Province_Name = province,
                Canton_Name = canton,
                District_Name = await JsRuntime.InvokeAsync<string>("getValue", "District"),
                Email_Confirmation = true,
                Photo = buffer,
            };
            UserService.UpdateUser(u);

            if (typeOfUser == "Client" || typeOfUser == "Entrepreneur")
            {
                Members m = new Members
                {
                    User_Email = _email.Email,
                    Score = 0,
                    Lat = 1.0,
                    Long = 1.0,
                    Direction = newMembers.Direction,
                };
                MembersService.AddMembers(m);
                if (typeOfUser == "Client") // Client
                {
                    Client cl = new Client
                    {
                        User_Email = _email.Email,
                    };
                    ClientService.AddClient(cl);

                    Shopping_Cart s = new Shopping_Cart
                    {
                        Email = _email.Email,
                    };

                    Shopping_CartService.addEmail(s);
                    // Likes for client
                    int selections = -1; // Sin categorías favoritas
                    foreach (var category in _categories)
                    {
                        selections = await JsRuntime.InvokeAsync<int>("getSelectedValues", "box_"+category.Id.ToString());
                        if (selections != -1)
                        {
                            Likes l = new Likes
                            {
                                Client_Email = _email.Email,
                                Category_Id = selections,
                            };
                            LikesService.AddLikes(l);
                        }
                    }
                }
                else // Entrepreneur
                {
                    Entrepreneur e = new Entrepreneur
                    {
                        User_Email = _email.Email,
                        Presentation = newEntrepreneur.Presentation,
                    };
                    EntrepreneurService.AddEntrepreneur(e);
                }
            }
            else // Administrator
            {
                Administrator a = new Administrator
                {
                    User_Email = _email.Email,
                };
                AdministratorService.AddAdministrator(a);
            }

            NavigationManager.NavigateTo("/Login");

        }
        else
        {
            await JsRuntime.InvokeVoidAsync("alerta", "Solo personas mayores de edad pueden registrarse en la página");
        }
    }

    /*
    Brief: Obtains the list of cantons according to the province chosen by the user.
    Parameters:
    Returns:
    */
    public async Task getCantons()
    {
        province = await JsRuntime.InvokeAsync<string>("getValue", "Province");
        _canton = CantonService.GetList(province);
        _district = DistrictService.GetList(".");
        await JsRuntime.InvokeVoidAsync("resetOption", "Canton");
        await JsRuntime.InvokeVoidAsync("resetOption", "District");
        await JsRuntime.InvokeVoidAsync("enabled", "Canton");
        await JsRuntime.InvokeVoidAsync("enabled", "District");
    }

    /*
    Brief: Obtains the list of districts according to the canton chosen by the user.
    Parameters:
    Returns:
    */
    public async Task getDistricts()
    {
        canton = await JsRuntime.InvokeAsync<string>("getValue", "Canton");
        _district = DistrictService.GetList(canton);
        await JsRuntime.InvokeVoidAsync("resetOption", "District");
    }
}

@*
    *  PIIB12021-15 Registration data:
    *      Interface improve, text-box align
    *      Add functionality to upload profile picture
    *      Add functionality for the user to choose their favourite categories
    *      Begin to split the registration form for each kind of user
    *      Fix address failures
    *
    *  Isaac Herrera Aguilar B4332
    *  Johel Phillips Ugalde B75821
    *  PIIB12021-15 Registration data:
    *      -Fix address failures
    *      -Interface improve, text-box align
    *      -Text box for address
    *      -Add functionality for the user to choose their favourite categories
    *      -Template for profile picture
*@