@page "/AddService"
@using EmprendeUCR_WebApplication.Data.Services
@using EmprendeUCR_WebApplication.Data.Entities
@using System;
@inject ServiceService  ServiceService
@inject NavigationManager NavigationManager
@inject EntrepreneurService EntrepreneurService
@inject Product_ServiceService Product_ServiceService
<h2>Agregar servicio</h2>
<hr />
<form>
    <div class="row">
        <div class="col-md-8">

            <div class="form-group">
                <label for="Name" class="control-label">Nombre</label>
                <input form="Name" class="form-control" @bind="@serv.Service_Name" required />
            </div>
            <div class="form-group">
                <label for="Service_Description" class="control-label">Descripción</label>
                <input form="Service_Description" class="form-control" @bind="@serv.Service_Description" />
            </div>
            <div class="form-group">
                <label for="Price" class="control-label">Precio por hora(CRC)</label>
                <input form="Price" type="number" class="form-control" @bind="@serv.Price_per_hour" />
            </div>



            <div class="form-group">
                <label for="Entrepreneur_Email" class="control-label">Emprendedor</label>
                <select @bind="prodServ.Entrepreneur_Email">
                    <option value="" selected disabled>Seleccione un emprendedor</option>
                    @if (entrepreneurs?.Count > 0)
                    {
                        @foreach (var cnt in entrepreneurs)
                        {
                            <option value="@cnt.User_Email">@cnt.User_Email @cnt.Presentation</option>
                        }
                    }
                </select>
            </div>

        </div>
    </div>
    <div>
        <h4 id="error" hidden="@hideError">Informacion incompleta.</h4>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <input type="button" class="btn btn-primary" @onclick="@onCreateService" value="Guardar" />
                <input type="button" class="btn btn-primary" @onclick="@Cancel" value="Cancelar" />
            </div>
        </div>
    </div>
</form>

@code {

    EmprendeUCR_WebApplication.Data.Entities.Service serv = new EmprendeUCR_WebApplication.Data.Entities.Service();
    Product_Service prodServ = new Product_Service();

    IList<Entrepreneur> entrepreneurs;
    private bool _isLoading = true;
    bool hideError = true;

    protected override async Task OnInitializedAsync()
    {
        entrepreneurs = await EntrepreneurService.GetAsync();
        _isLoading = false;
    }

    protected Task createService()
    {

        if (String.IsNullOrEmpty(serv.Entrepreneur_Email))
        {
            // service details are incomplete, show error
            hideError = false;
            return Task.CompletedTask;
        }
        else
        {
            return ServiceService.InsertServiceAsync(serv);
        }

    }

    protected async Task<int> createProduct_Service()
    {
        if (String.IsNullOrEmpty(prodServ.Entrepreneur_Email))
        {
            // productService details are incomplete, show error
            hideError = false;
            await Task.CompletedTask;

            return 0;
        }
        else
        {
            int id = await Product_ServiceService.InsertProductServiceAsync(prodServ);

            return id;

        }
    }

    protected async void onCreateService()
    {
        prodServ.Availability = 1;
        prodServ.Category_ID = 1;

        serv.Category_ID = 1;
        serv.Entrepreneur_Email = prodServ.Entrepreneur_Email;



        int idToInsert = await createProduct_Service();
        serv.Code_ID = idToInsert;
        await createService();

        NavigationManager.NavigateTo("ListService");
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("ListService");
    }

}